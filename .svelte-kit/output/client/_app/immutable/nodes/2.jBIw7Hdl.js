import"../chunks/DsnmJJEf.js";import{i as ia}from"../chunks/45RDoFcG.js";import{w as sa,o as la,e as le,a as R}from"../chunks/DDR6tWfP.js";import{h as ae,d as ca,b as da,w as a,Q as ua,r as fa,H as va,e as pt,g as Ke,i as Ge,o as xe,R as ma,S as pa,k as it,m as ba,l as me,T as wt,V as xt,j as kt,v as H,W as bt,X as _t,n as Pt,p as _a,Y as Me,Z as Je,_ as Et,$ as Ne,a0 as ha,a1 as ya,a2 as ga,a3 as wa,a4 as xa,a5 as ka,a6 as Pa,a7 as St,a8 as At,a9 as Ea,aa as Mt,ab as Sa,ac as Aa,ad as Ma,t as Na,ae as Da,af as Ia,ag as Ta,ah as Fa,B as N,ai as Ca,aj as Ua,J as Ba,ak as Ye,al as Ha,K as $,L as G,a as O,M as La,P as y,x as d,N as g,O as _,am as Ra,c as Oa,f as ht,an as $a}from"../chunks/uVtHz8AV.js";import{i as ee,s as za,a as qa}from"../chunks/DbUCoicb.js";function Xe(t,r){return r}function Wa(t,r,e){for(var n=t.items,o=[],i=r.length,c=0;c<i;c++)ga(r[c].e,o,!0);var u=i>0&&o.length===0&&e!==null;if(u){var w=e.parentNode;wa(w),w.append(e),n.clear(),te(t,r[0].prev,r[i-1].next)}xa(o,()=>{for(var f=0;f<i;f++){var S=r[f];u||(n.delete(S.k),te(t,S.prev,S.next)),Et(S.e,!u)}})}function Ze(t,r,e,n,o,i=null){var c=t,u={flags:r,items:new Map,first:null},w=(r&St)!==0;if(w){var f=t;c=ae?Ke(Pa(f)):f.appendChild(kt())}ae&&ca();var S=null,Q=!1,D=new Map,W=ua(()=>{var P=e();return xt(P)?P:P==null?[]:wt(P)}),v,m;function h(){ja(m,v,u,D,c,o,r,n,e),i!==null&&(v.length===0?S?Pt(S):S=it(()=>i(c)):S!==null&&_a(S,()=>{S=null}))}da(()=>{m??=ka,v=a(W);var P=v.length;if(Q&&P===0)return;Q=P===0;let x=!1;if(ae){var I=fa(c)===va;I!==(P===0)&&(c=pt(),Ke(c),Ge(!1),x=!0)}if(ae){for(var M=null,E,s=0;s<P;s++){if(xe.nodeType===ma&&xe.data===pa){c=xe,x=!0,Ge(!1);break}var p=v[s],b=n(p,s);E=st(xe,u,M,null,p,b,s,o,r,e),u.items.set(b,E),M=E}P>0&&Ke(pt())}if(ae)P===0&&i&&(S=it(()=>i(c)));else if(ba()){var C=new Set,z=me;for(s=0;s<P;s+=1){p=v[s],b=n(p,s);var U=u.items.get(b)??D.get(b);U?(r&(Ne|Me))!==0&&Nt(U,p,s,r):(E=st(null,u,null,null,p,b,s,o,r,e,!0),D.set(b,E)),C.add(b)}for(const[L,Y]of u.items)C.has(L)||z.skipped_effects.add(Y.e);z.add_callback(h)}else h();x&&Ge(!0),a(W)}),ae&&(c=xe)}function ja(t,r,e,n,o,i,c,u,w){var f=(c&Ea)!==0,S=(c&(Ne|Me))!==0,Q=r.length,D=e.items,W=e.first,v=W,m,h=null,P,x=[],I=[],M,E,s,p;if(f)for(p=0;p<Q;p+=1)M=r[p],E=u(M,p),s=D.get(E),s!==void 0&&(s.a?.measure(),(P??=new Set).add(s));for(p=0;p<Q;p+=1){if(M=r[p],E=u(M,p),s=D.get(E),s===void 0){var b=n.get(E);if(b!==void 0){n.delete(E),D.set(E,b);var C=h?h.next:v;te(e,h,b),te(e,b,C),et(b,C,o),h=b}else{var z=v?v.e.nodes_start:o;h=st(z,e,h,h===null?e.first:h.next,M,E,p,i,c,w)}D.set(E,h),x=[],I=[],v=h.next;continue}if(S&&Nt(s,M,p,c),(s.e.f&Je)!==0&&(Pt(s.e),f&&(s.a?.unfix(),(P??=new Set).delete(s))),s!==v){if(m!==void 0&&m.has(s)){if(x.length<I.length){var U=I[0],L;h=U.prev;var Y=x[0],ce=x[x.length-1];for(L=0;L<x.length;L+=1)et(x[L],U,o);for(L=0;L<I.length;L+=1)m.delete(I[L]);te(e,Y.prev,ce.next),te(e,h,Y),te(e,ce,U),v=U,h=ce,p-=1,x=[],I=[]}else m.delete(s),et(s,v,o),te(e,s.prev,s.next),te(e,s,h===null?e.first:h.next),te(e,h,s),h=s;continue}for(x=[],I=[];v!==null&&v.k!==E;)(v.e.f&Je)===0&&(m??=new Set).add(v),I.push(v),v=v.next;if(v===null)continue;s=v}x.push(s),h=s,v=s.next}if(v!==null||m!==void 0){for(var K=m===void 0?[]:wt(m);v!==null;)(v.e.f&Je)===0&&K.push(v),v=v.next;var oe=K.length;if(oe>0){var De=(c&St)!==0&&Q===0?o:null;if(f){for(p=0;p<oe;p+=1)K[p].a?.measure();for(p=0;p<oe;p+=1)K[p].a?.fix()}Wa(e,K,De)}}f&&At(()=>{if(P!==void 0)for(s of P)s.a?.apply()}),t.first=e.first&&e.first.e,t.last=h&&h.e;for(var Ie of n.values())Et(Ie.e);n.clear()}function Nt(t,r,e,n){(n&Ne)!==0&&_t(t.v,r),(n&Me)!==0?_t(t.i,e):t.i=e}function st(t,r,e,n,o,i,c,u,w,f,S){var Q=(w&Ne)!==0,D=(w&ha)===0,W=Q?D?H(o,!1,!1):bt(o):o,v=(w&Me)===0?c:bt(c),m={i:v,v:W,k:i,a:null,e:null,prev:e,next:n};try{if(t===null){var h=document.createDocumentFragment();h.append(t=kt())}return m.e=it(()=>u(t,W,v,f),ae),m.e.prev=e&&e.e,m.e.next=n&&n.e,e===null?S||(r.first=m):(e.next=m,e.e.next=m.e),n!==null&&(n.prev=m,n.e.prev=m.e),m}finally{}}function et(t,r,e){for(var n=t.next?t.next.e.nodes_start:e,o=r?r.e.nodes_start:e,i=t.e.nodes_start;i!==null&&i!==n;){var c=ya(i);o.before(i),i=c}}function te(t,r,e){r===null?t.first=e:(r.next=e,r.e.next=e&&e.e),e!==null&&(e.prev=r,e.e.prev=r&&r.e)}function Dt(t,r,e=!1){if(t.multiple){if(r==null)return;if(!xt(r))return Aa();for(var n of t.options)n.selected=r.includes(ke(n));return}for(n of t.options){var o=ke(n);if(Ma(o,r)){n.selected=!0;return}}(!e||r!==void 0)&&(t.selectedIndex=-1)}function Va(t){var r=new MutationObserver(()=>{Dt(t,t.__value)});r.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["value"]}),Na(()=>{r.disconnect()})}function Qa(t,r,e=r){var n=!0;Mt(t,"change",o=>{var i=o?"[selected]":":checked",c;if(t.multiple)c=[].map.call(t.querySelectorAll(i),ke);else{var u=t.querySelector(i)??t.querySelector("option:not([disabled])");c=u&&ke(u)}e(c)}),Sa(()=>{var o=r();if(Dt(t,o,n),n&&o===void 0){var i=t.querySelector(":checked");i!==null&&(o=ke(i),e(o))}t.__value=o,n=!1}),Va(t)}function ke(t){return"__value"in t?t.__value:t.value}const Ka=Symbol("is custom element"),Ga=Symbol("is html");function Se(t){if(ae){var r=!1,e=()=>{if(!r){if(r=!0,t.hasAttribute("value")){var n=t.value;yt(t,"value",null),t.value=n}if(t.hasAttribute("checked")){var o=t.checked;yt(t,"checked",null),t.checked=o}}};t.__on_r=e,At(e),Da()}}function Ja(t,r){r?t.hasAttribute("selected")||t.setAttribute("selected",""):t.removeAttribute("selected")}function yt(t,r,e,n){var o=Ya(t);ae&&(o[r]=t.getAttribute(r),r==="src"||r==="srcset"||r==="href"&&t.nodeName==="LINK")||o[r]!==(o[r]=e)&&(r==="loading"&&(t[Ia]=e),t.removeAttribute(r))}function Ya(t){return t.__attributes??={[Ka]:t.nodeName.includes("-"),[Ga]:t.namespaceURI===Ta}}function Ae(t,r,e=r){var n=new WeakSet;Mt(t,"input",async o=>{var i=o?t.defaultValue:t.value;if(i=tt(t)?at(i):i,e(i),me!==null&&n.add(me),await Fa(),i!==(i=r())){var c=t.selectionStart,u=t.selectionEnd;t.value=i??"",u!==null&&(t.selectionStart=c,t.selectionEnd=Math.min(u,t.value.length))}}),(ae&&t.defaultValue!==t.value||N(r)==null&&t.value)&&(e(tt(t)?at(t.value):t.value),me!==null&&n.add(me)),Ca(()=>{var o=r();if(t===document.activeElement){var i=Ua??me;if(n.has(i))return}tt(t)&&o===at(t.value)||t.type==="date"&&!o&&!t.value||o!==t.value&&(t.value=o??"")})}function tt(t){var r=t.type;return r==="number"||r==="range"}function at(t){return t===""?null:+t}function gt(t){return function(...r){var e=r[0];return e.preventDefault(),t?.apply(this,r)}}const lt=sa([]),Xa=lt;let rt=null,nt=null;function Pe(){return rt||(rt=(async()=>{const r=await(await pe()).list();lt.set(It(r))})()),rt}async function Za(t){await Pe();const r=await pe(),e=Date.now(),n={id:crypto.randomUUID(),name:t.name.trim()||"Pack sin nombre",createdAt:e,updatedAt:e,phrases:t.phrases};return await r.save(n),await ct(),n}async function er(t,r,e={}){await Pe();const n=await pe(),o=await n.get(t);if(!o)throw new Error("Pack no encontrado");const i={...o,name:e.updateName?.trim()||o.name,updatedAt:Date.now(),phrases:[...o.phrases,r]};return await n.save(i),await ct(),i}async function tr(t){await Pe(),await(await pe()).delete(t),await ct()}async function ar(t,r){await Pe();const n=await(await pe()).get(t);if(n)return n.phrases.find(o=>o.id===r)}async function ct(){const r=await(await pe()).list();lt.set(It(r))}function It(t){return[...t].sort((r,e)=>e.updatedAt-r.updatedAt)}async function pe(){return nt||(nt=(async()=>{const t=await rr();return t||nr()})()),nt}async function rr(){const t=navigator.storage;if(!t?.getDirectory)return null;try{const e=await(await t.getDirectory()).getDirectoryHandle("phrase-packs",{create:!0});return{list:async()=>{const n=[];for await(const o of e.entries()){const[i,c]=o;if(!i.endsWith(".json"))continue;const f=await(await c.getFile()).text();n.push(JSON.parse(f))}return n},save:async n=>{const i=await(await e.getFileHandle(`${n.id}.json`,{create:!0})).createWritable();await i.write(JSON.stringify(n)),await i.close()},delete:async n=>{try{await e.removeEntry(`${n}.json`)}catch(o){if(o?.name!=="NotFoundError")throw o}},get:async n=>{try{const i=await(await e.getFileHandle(`${n}.json`)).getFile();return JSON.parse(await i.text())}catch(o){if(o?.name==="NotFoundError")return;throw o}}}}catch(r){return console.warn("Fallo OPFS, usando IndexedDB",r),null}}function nr(){return new Promise((t,r)=>{const e=indexedDB.open("doremix",1);e.onupgradeneeded=()=>{const n=e.result;n.objectStoreNames.contains("phrasePacks")||n.createObjectStore("phrasePacks",{keyPath:"id"})},e.onerror=()=>{r(e.error??new Error("Error al abrir IndexedDB"))},e.onsuccess=()=>{const n=e.result;n.onversionchange=()=>{n.close()},t({list:()=>new Promise((i,c)=>{const f=n.transaction("phrasePacks","readonly").objectStore("phrasePacks").getAll();f.onsuccess=()=>i(f.result),f.onerror=()=>c(f.error)}),save:i=>new Promise((c,u)=>{const w=n.transaction("phrasePacks","readwrite");w.oncomplete=()=>c(),w.onerror=()=>u(w.error),w.objectStore("phrasePacks").put(i)}),delete:i=>new Promise((c,u)=>{const w=n.transaction("phrasePacks","readwrite");w.oncomplete=()=>c(),w.onerror=()=>u(w.error),w.objectStore("phrasePacks").delete(i)}),get:i=>new Promise((c,u)=>{const f=n.transaction("phrasePacks","readonly").objectStore("phrasePacks").get(i);f.onsuccess=()=>c(f.result),f.onerror=()=>u(f.error)})})}})}class ve extends Error{constructor(r){super(r),this.name="SMFParseError"}}const or=1297377380,ir=1297379947;function sr(t){const r=new DataView(t);let e=0;if(r.getUint32(e)!==or)throw new ve("Archivo SMF inválido (cabecera incorrecta).");e+=4;const o=r.getUint32(e);if(e+=4,o!==6)throw new ve("Cabecera SMF con longitud inesperada.");const i=r.getUint16(e);e+=2;const c=r.getUint16(e);e+=2;const u=r.getUint16(e);if(e+=2,u&32768)throw new ve("Formato SMPTE no soportado, solo PPQ.");const w=u,f=[],S=[];let Q,D=0;for(let m=0;m<c&&!(e>=r.byteLength);m++){const h=r.getUint32(e);if(e+=4,h!==ir)throw new ve("Chunk de pista no encontrado.");const P=r.getUint32(e);e+=4;const x=e+P;let I=0,M=0;for(;e<x;){const E=ot(r,e);I+=E.value,e=E.offset;const s=r.getUint8(e);if(s>=128&&(M=s,e+=1),M===255){const C=r.getUint8(e);e+=1;const z=ot(r,e),U=z.value;e=z.offset;const L=e;if(e+=U,C===81&&U===3){const Y=r.getUint8(L)<<16|r.getUint8(L+1)<<8|r.getUint8(L+2);Q=Math.round(6e7/Y*100)/100}else if(C===3){const Y=new Uint8Array(t,L,U),K=new TextDecoder().decode(Y).trim();K&&S.push(K)}continue}if(M===240||M===247){const C=ot(r,e),z=C.value;e=C.offset+z;continue}if(M===0)throw new ve("Estado MIDI inválido en el archivo.");const p=M&240,b=M&15;switch(p){case 128:case 144:{const C=r.getUint8(e),z=r.getUint8(e+1);e+=2;const U=I/w;p===144&&z!==0?f.push({beat:U,type:"noteon",note:C,velocity:z/127,channel:b}):f.push({beat:U,type:"noteoff",note:C,channel:b});break}case 160:case 176:case 224:{e+=2;break}case 192:case 208:{e+=1;break}default:throw new ve("Evento MIDI desconocido.")}I>D&&(D=I)}e=x}f.sort((m,h)=>m.beat-h.beat);const W=f.map(m=>{const{channel:h,...P}=m;return P});return{metadata:{formatType:i,trackCount:c,ticksPerQuarter:w,tempoBpm:Q,trackNames:S,durationBeats:D/w},events:W}}function ot(t,r){let e=0,n=0;do n=t.getUint8(r++),e=e<<7|n&127;while(n&128);return{value:e,offset:r}}var lr=$('<span style="opacity:0.7;">Procesando…</span>'),cr=$('<span style="opacity:0.7;"> </span>'),dr=$('<p style="color:#ff6b6b; margin:0 0 0.8rem 0;"> </p>'),ur=$("<li> </li>"),fr=$('<div style="border:1px solid #2a2a2a; border-radius:10px; padding:0.8rem;"><h3 style="margin:0 0 0.5rem 0; font-size:1rem;">Metadatos extraídos</h3> <ul style="margin:0; padding-left:1.2rem; line-height:1.6;"><li> </li> <li> </li> <li> </li> <li> </li> <!></ul></div>'),vr=$('<p style="opacity:0.7;">Inicializando almacenamiento local…</p>'),mr=$('<p style="color:#ff6b6b; margin-bottom:0.8rem;"> </p>'),pr=$("<option> </option>"),br=$('<p style="opacity:0.7;">No hay packs guardados todavía. Guarda el clip de ejemplo para crear el primero.</p>'),_r=$('<p style="opacity:0.6; margin:0;">No hay frases en este pack.</p>'),hr=$('<span style="opacity:0.6; font-size:0.85rem;"> </span>'),yr=$('<li style="display:flex; align-items:center; gap:0.6rem;"><button type="button" style="padding:0.35rem 0.9rem; border-radius:8px; background:#2c7efc; color:#fff; border:0;"> </button> <span> </span> <!></li>'),gr=$('<ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:0.4rem;"></ul>'),wr=$('<li style="border:1px solid #2a2a2a; border-radius:10px; padding:0.8rem;"><div style="display:flex; justify-content:space-between; align-items:center; gap:0.6rem; margin-bottom:0.6rem;"><div><strong> </strong> <span style="opacity:0.6; font-size:0.85rem; margin-left:0.4rem;"> </span></div> <button type="button" style="padding:0.4rem 0.9rem; border-radius:8px; background:#c0392b; color:#fff; border:0;"> </button></div> <!></li>'),xr=$('<ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:0.8rem;"></ul>'),kr=$('<!> <div style="display:grid; gap:1rem; margin-bottom:1.2rem;"><form style="display:flex; flex-wrap:wrap; gap:0.6rem; align-items:center;"><strong style="min-width:12rem;">Nuevo pack desde el clip actual</strong> <input type="text" placeholder="Nombre del pack" style="flex:1 1 160px; min-width:160px; padding:0.45rem; background:#181818; color:#fff; border:1px solid #333; border-radius:8px;"/> <input type="text" placeholder="Nombre de la frase" style="flex:1 1 160px; min-width:160px; padding:0.45rem; background:#181818; color:#fff; border:1px solid #333; border-radius:8px;"/> <button type="submit" style="padding:0.55rem 1.2rem; border-radius:10px; background:#27ae60; color:#fff; border:0;"> </button></form> <form style="display:flex; flex-wrap:wrap; gap:0.6rem; align-items:center;"><strong style="min-width:12rem;">Añadir al pack seleccionado</strong> <select style="flex:0 1 220px; min-width:160px; padding:0.45rem; background:#181818; color:#fff; border:1px solid #333; border-radius:8px;"><option disabled>Selecciona un pack</option><!></select> <input type="text" placeholder="Nombre de la frase" style="flex:1 1 160px; min-width:160px; padding:0.45rem; background:#181818; color:#fff; border:1px solid #333; border-radius:8px;"/> <button type="submit" style="padding:0.55rem 1.2rem; border-radius:10px; background:#f39c12; color:#fff; border:0;"> </button></form></div> <div><h3 style="font-size:1rem; margin:0 0 0.5rem 0;">Mis packs guardados</h3> <!></div>',1),Pr=$('<main class="p-6 min-h-screen" style="font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, sans-serif; background:#0b0b0b; color:#f2f2f2;"><h1 style="font-size:2rem; font-weight:700; margin-bottom:1rem;">DoReMix — PWA (SvelteKit)</h1> <p style="opacity:0.8; margin-bottom:1.5rem;">Demo: reproduce un pequeño "clip" de 1 compás con un sintetizador en AudioWorklet.</p> <div style="display:flex; gap:1rem; align-items:center; margin-bottom:1rem;"><label for="bpm-input">BPM</label> <input id="bpm-input" type="number" min="40" max="240" style="width:5rem; padding:0.4rem; background:#181818; color:#fff; border:1px solid #333; border-radius:8px;"/> <button style="padding:0.6rem 1rem; border-radius:10px; background:#2c7efc; color:#fff; border:0;">Play</button> <button style="padding:0.6rem 1rem; border-radius:10px; background:#444; color:#fff; border:0;">Stop</button></div> <p style="opacity:0.7; margin-bottom:1.5rem;"> </p> <section style="border:1px solid #333; border-radius:12px; padding:1.2rem; max-width:820px; margin-bottom:2rem;"><h2 style="font-size:1.2rem; margin:0 0 0.8rem 0;">Importar SMF (.mid)</h2> <p style="opacity:0.75; margin-bottom:0.8rem;">Carga un archivo MIDI estándar para convertirlo en la frase activa.</p> <div style="display:flex; flex-wrap:wrap; gap:0.8rem; align-items:center; margin-bottom:0.8rem;"><label for="smf-file" style="min-width:8rem;">Archivo SMF</label> <input id="smf-file" type="file" accept=".mid,.midi" style="flex:1 1 240px; min-width:220px; padding:0.45rem; background:#181818; color:#fff; border:1px solid #333; border-radius:8px;"/> <!></div> <!> <!></section> <section style="border:1px solid #333; border-radius:12px; padding:1.2rem; max-width:820px; margin-bottom:2rem;"><h2 style="font-size:1.2rem; margin:0 0 0.8rem 0;">Packs de frases (IndexedDB / OPFS)</h2> <!></section> <div style="border:1px solid #333; border-radius:12px; padding:1rem; max-width:720px;"><h2 style="font-size:1.2rem; margin:0 0 0.5rem 0;">Qué incluye este esqueleto</h2> <ul style="line-height:1.6;"><li>AudioWorklet con sintetizador simple (seno) y <em>scheduler</em> básico</li> <li>VitePWA: manifest & service worker (instalable/offline)</li> <li>Página de prueba + controles</li></ul></div></main>');function Dr(t,r){Ba(r,!1);const e=()=>qa(Xa,"$phrasePacks",n),[n,o]=za(),i=H(),c=H();let u,w,f=H(120),S=H(!1);const Q=[{beat:0,type:"noteon",note:60,velocity:.8},{beat:.5,type:"noteoff",note:60},{beat:1,type:"noteon",note:64,velocity:.8},{beat:1.5,type:"noteoff",note:64},{beat:2,type:"noteon",note:67,velocity:.8},{beat:2.5,type:"noteoff",note:67},{beat:3,type:"noteon",note:72,velocity:.8},{beat:3.5,type:"noteoff",note:72}];let D=H({id:"default-phrase",name:"Clip demo",bpm:a(f),events:U(Q)}),W=a(D).events,v=H(!1),m=H(null),h=H("Pack demo"),P=H(a(D).name),x=H(""),I=H(!1),M=H(!1),E=H(null),s=H(null),p=H(null),b=H(null),C=H(!1),z=H("");function U(l){return l.map(k=>({...k}))}function L(l){return{id:crypto.randomUUID(),name:l?.trim()||a(c),bpm:a(f),events:U(W)}}async function Y(){u||(u=new AudioContext({latencyHint:"interactive"}),await u.audioWorklet.addModule("/engine.worklet.js"),w=new AudioWorkletNode(u,"doremix-synth"),w.connect(u.destination))}function ce(){if(!W.length)return;const l=60/a(f),k=u.currentTime+.1,A=W.map(B=>({t:k+B.beat*l,type:B.type,note:B.note,velocity:B.velocity??0}));w.port.postMessage({type:"schedule",events:A})}async function K(){await Y(),await u.resume(),d(S,!0),ce()}function oe(){u&&(w.port.postMessage({type:"allnotesoff"}),d(S,!1))}async function De(){if(!(!a(v)||a(I))){d(I,!0),d(m,null);try{const l=L(a(P)),k=await Za({name:a(h).trim()||"Pack sin nombre",phrases:[l]});d(x,k.id)}catch(l){d(m,l.message??"Error guardando pack")}finally{d(I,!1)}}}async function Ie(){if(!(!a(x)||a(M))){d(M,!0),d(m,null);try{const l=L(a(P));await er(a(x),l)}catch(l){d(m,l.message??"Error guardando frase")}finally{d(M,!1)}}}async function Tt(l,k){if(!a(E)){d(E,`${l}:${k}`),d(m,null);try{const A=await ar(l,k);if(!A)return;const B=A.bpm??a(f);d(D,{...A,bpm:B,events:U(A.events)}),W=a(D).events,d(f,B),d(P,A.name),a(S)&&(oe(),await K())}catch(A){d(m,A.message??"Error cargando frase")}finally{d(E,null)}}}async function Ft(l){if(!a(s)){d(s,l),d(m,null);try{await tr(l),a(x)===l&&d(x,"")}catch(k){d(m,k.message??"Error eliminando pack")}finally{d(s,null)}}}async function Ct(l){const k=l.currentTarget,A=k?.files?.[0];if(A){d(C,!0),d(p,null),d(b,null),d(z,A.name);try{const B=await A.arrayBuffer(),j=sr(B);if(!j.events.length)throw new Error("El archivo no contiene notas.");const V=j.metadata.tempoBpm??a(f)??120,X=j.metadata.trackNames[0]||A.name.replace(/\.(mid|midi)$/i,"")||"Frase desde SMF",Z=U(j.events);W=Z,d(D,{id:crypto.randomUUID(),name:X,bpm:V,events:Z}),d(f,V),d(P,X),a(S)&&(oe(),await K()),d(b,j.metadata),k.value=""}catch(B){d(p,B.message??"No fue posible leer el archivo MIDI.")}finally{d(C,!1)}}}la(async()=>{try{await Pe(),d(v,!0)}catch(l){d(m,l.message??"No fue posible inicializar el almacenamiento local.")}}),Ye(()=>e(),()=>{d(i,e().length)}),Ye(()=>a(D),()=>{d(c,a(D)?.name??"Clip actual")}),Ye(()=>(a(v),a(x),a(i),e()),()=>{a(v)&&!a(x)&&a(i)>0&&d(x,e()[0].id)}),Ha(),ia();var Te=Pr(),Fe=y(g(Te),4),Ce=y(g(Fe),2);Se(Ce);var Ue=y(Ce,2),dt=y(Ue,2);_(Fe);var Be=y(Fe,2),Ut=g(Be);_(Be);var He=y(Be,2),Le=y(g(He),4),Re=y(g(Le),2),Bt=y(Re,2);{var Ht=l=>{var k=lr();O(l,k)},Lt=l=>{var k=Oa(),A=ht(k);{var B=j=>{var V=cr(),X=g(V);_(V),G(()=>R(X,`Último archivo: ${a(z)??""}`)),O(j,V)};ee(A,j=>{a(z)&&j(B)},!0)}O(l,k)};ee(Bt,l=>{a(C)?l(Ht):l(Lt,!1)})}_(Le);var ut=y(Le,2);{var Rt=l=>{var k=dr(),A=g(k,!0);_(k),G(()=>R(A,a(p))),O(l,k)};ee(ut,l=>{a(p)&&l(Rt)})}var Ot=y(ut,2);{var $t=l=>{var k=fr(),A=y(g(k),2),B=g(A),j=g(B);_(B);var V=y(B,2),X=g(V);_(V);var Z=y(V,2),be=g(Z);_(Z);var _e=y(Z,2),he=g(_e);_(_e);var de=y(_e,2);{var ue=ie=>{var se=ur(),ye=g(se);_(se),G(Oe=>R(ye,`Nombres de pista: ${Oe??""}`),[()=>(a(b),N(()=>a(b).trackNames.join(", ")))]),O(ie,se)};ee(de,ie=>{a(b),N(()=>a(b).trackNames.length)&&ie(ue)})}_(A),_(k),G(ie=>{R(j,`Formato: ${a(b),N(()=>a(b).formatType)??""} (${a(b),N(()=>a(b).trackCount)??""} pistas)`),R(X,`Resolución: ${a(b),N(()=>a(b).ticksPerQuarter)??""} ticks por negra`),R(be,`BPM detectado: ${a(b),N(()=>a(b).tempoBpm??"sin meta tempo (usando actual)")??""}`),R(he,`Duración (compases aprox.): ${ie??""}`)},[()=>(a(b),N(()=>Math.max(0,a(b).durationBeats/4).toFixed(2)))]),O(l,k)};ee(Ot,l=>{a(b)&&l($t)})}_(He);var ft=y(He,2),zt=y(g(ft),2);{var qt=l=>{var k=vr();O(l,k)},Wt=l=>{var k=kr(),A=ht(k);{var B=T=>{var q=mr(),re=g(q,!0);_(q),G(()=>R(re,a(m))),O(T,q)};ee(A,T=>{a(m)&&T(B)})}var j=y(A,2),V=g(j),X=y(g(V),2);Se(X);var Z=y(X,2);Se(Z);var be=y(Z,2),_e=g(be,!0);_(be),_(V);var he=y(V,2),de=y(g(he),2);G(()=>{a(x),$a(()=>{a(i),e()})});var ue=g(de);ue.value=ue.__value="";var ie=y(ue);Ze(ie,1,e,Xe,(T,q)=>{var re=pr(),F=g(re,!0);_(re);var fe={};G(()=>{R(F,(a(q),N(()=>a(q).name))),fe!==(fe=(a(q),N(()=>a(q).id)))&&(re.value=(re.__value=(a(q),N(()=>a(q).id)))??"")}),O(T,re)}),_(de);var se=y(de,2);Se(se);var ye=y(se,2),Oe=g(ye,!0);_(ye),_(he),_(j);var vt=y(j,2),jt=y(g(vt),2);{var Vt=T=>{var q=br();O(T,q)},Qt=T=>{var q=xr();Ze(q,5,e,Xe,(re,F)=>{var fe=wr(),$e=g(fe),ze=g($e),qe=g(ze),Kt=g(qe,!0);_(qe);var mt=y(qe,2),Gt=g(mt,!0);_(mt),_(ze);var Ee=y(ze,2),Jt=g(Ee,!0);_(Ee),_($e);var Yt=y($e,2);{var Xt=ne=>{var ge=_r();O(ne,ge)},Zt=ne=>{var ge=gr();Ze(ge,5,()=>(a(F),N(()=>a(F).phrases)),Xe,(ea,J)=>{var We=yr(),we=g(We),ta=g(we,!0);_(we);var je=y(we,2),aa=g(je,!0);_(je);var ra=y(je,2);{var na=Ve=>{var Qe=hr(),oa=g(Qe);_(Qe),G(()=>R(oa,`${a(J),N(()=>a(J).bpm)??""} BPM`)),O(Ve,Qe)};ee(ra,Ve=>{a(J),N(()=>a(J).bpm)&&Ve(na)})}_(We),G(()=>{we.disabled=(a(E),a(F),a(J),N(()=>a(E)===`${a(F).id}:${a(J).id}`)),R(ta,(a(E),a(F),a(J),N(()=>a(E)===`${a(F).id}:${a(J).id}`?"Cargando…":"Cargar"))),R(aa,(a(J),N(()=>a(J).name)))}),le("click",we,()=>Tt(a(F).id,a(J).id)),O(ea,We)}),_(ge),O(ne,ge)};ee(Yt,ne=>{a(F),N(()=>!a(F).phrases.length)?ne(Xt):ne(Zt,!1)})}_(fe),G(ne=>{R(Kt,(a(F),N(()=>a(F).name))),R(Gt,ne),Ee.disabled=(a(s),a(F),N(()=>a(s)===a(F).id)),R(Jt,(a(s),a(F),N(()=>a(s)===a(F).id?"Eliminando…":"Eliminar")))},[()=>(a(F),N(()=>new Date(a(F).updatedAt).toLocaleString()))]),le("click",Ee,()=>Ft(a(F).id)),O(re,fe)}),_(q),O(T,q)};ee(jt,T=>{e(),N(()=>!e().length)?T(Vt):T(Qt,!1)})}_(vt),G(()=>{be.disabled=a(I),R(_e,a(I)?"Guardando…":"Guardar como nuevo pack"),Ja(ue,a(x)===""||a(i)===0),ye.disabled=!a(x)||a(M),R(Oe,a(M)?"Añadiendo…":"Añadir frase al pack")}),Ae(X,()=>a(h),T=>d(h,T)),Ae(Z,()=>a(P),T=>d(P,T)),le("submit",V,gt(De)),Qa(de,()=>a(x),T=>d(x,T)),Ae(se,()=>a(P),T=>d(P,T)),le("submit",he,gt(Ie)),O(l,k)};ee(zt,l=>{a(v)?l(Wt,!1):l(qt)})}_(ft),Ra(2),_(Te),G(()=>{Ue.disabled=a(S),dt.disabled=!a(S),R(Ut,`Frase actual: ${a(c)??""}`),Re.disabled=a(C)}),Ae(Ce,()=>a(f),l=>d(f,l)),le("click",Ue,K),le("click",dt,oe),le("change",Re,Ct),O(t,Te),La(),o()}export{Dr as component};
